{% extends "base.html" %}

{% block title %}房间 {{ room_id }} - 军旗棋盘{% endblock %}

{% block content %}
<audio id="selectSound" src="/audio/select.mp3" preload="auto"></audio>
<audio id="moveSound" src="/audio/move.mp3" preload="auto"></audio>
<audio id="attackSound" src="/audio/attack.mp3" preload="auto"></audio>
<audio id="40lostSound" src="/audio/40lost.mp3" preload="auto"></audio>
<audio id="winSound" src="/audio/win.mp3" preload="auto"></audio>
<audio id="loseSound" src="/audio/lose.mp3" preload="auto"></audio>
<audio id="drawSound" src="/audio/draw.mp3" preload="auto"></audio>

<div class="d-flex justify-content-between mb-4">
    <a href="/" class="btn btn-secondary" onclick="$('.leave-btn').click();">
        <i class="fas fa-arrow-left me-2"></i>返回首页
    </a>
</div>

<div class="row">
    <!-- 左侧：信息和管理区域 -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">房间控制</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">房间类型</label>
                    <select class="form-select" id="roomTypeSelect">
                        <option value="2" {% if room.room_type == 2 %}selected{% endif %}>2人游戏</option>
                        <option value="4" {% if room.room_type == 4 %}selected{% endif %}>4人游戏</option>
                        <option value="6" {% if room.room_type == 6 %}selected{% endif %}>6人游戏</option>
                        <option value="8" {% if room.room_type == 8 %}selected{% endif %}>8人游戏</option>
                    </select>
                </div>
                
                <div class="d-grid">
                    <button id="startGameBtn" class="btn btn-success mb-2" {% if not room.can_start_game() %}disabled{% endif %} {% if room.active %}style="display:none"{% endif %}>
                        <i class="fas fa-play me-2"></i>开始游戏
                    </button>
                    <button id="EndGameBtn" class="btn btn-danger" {% if not room.active %}style="display:none"{% endif %}>
                        <i class="fas fa-stop me-2"></i>结束游戏
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">玩家座位</h4>
            </div>
            <div class="card-body p-0">
                <div id="playersList" class="list-group list-group-flush">
                    <!-- 玩家列表将通过JavaScript动态更新 -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="userSeatInfo" class="alert alert-info mt-3">
            <!-- 用户座位信息将通过JavaScript动态更新 -->
        </div>
        
        <!-- 聊天窗口 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-comments me-2"></i>聊天窗口</h5>
            </div>
            <div class="card-body p-0">
                <div class="chatWindow" id="chatWindow" style="height: 200px; overflow-y: auto; padding: 10px;">
                    <!-- 聊天消息将通过JavaScript动态更新 -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" class="form-control" id="chatInput" placeholder="输入消息..." autocomplete="off">
                    <button class="btn btn-primary" id="sendMessageBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 棋盘区域 -->
    <div class="col-md-8">
        <div class="card" style="width: 1032px;">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-chess-rook me-2"></i>军旗棋盘 - 房间 {{ room_id }}</h3>
                <button class="btn btn-md btn-danger" id="clearTagBtn" style="position: absolute; right:20px; top:20px;">
                    清空标记</button>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">提示：点击棋盘空白处可发送表情</span>
                    <span class="text-muted">
                        行棋提示器校准：
                        <button id="sectorLeftBtn" class="btn btn-sm btn-primary me-2"><i class="fas fa-rotate-right"></i></button>
                        <button id="sectorRightBtn" class="btn btn-sm btn-primary"><i class="fas fa-rotate-left"></i></button>
                    </span>
                </div>
                <div class="text-center mb-4" style="height: 1000px; position: relative;" id="boardContainer">
                    <img id="board-img" src="" alt="军旗棋盘" class="img-fluid" style="max-height: 100%; max-width: 100%;">
                    <svg id="arrowLayer" width="100%" height="100%" 
                        style="position:absolute; top:0; left:0; pointer-events:none; z-index:20;">
                        <defs>
                        <marker id="arrowheadB" markerWidth="10" markerHeight="7" 
                                refX="10" refY="3.5" orient="auto" fill="black">
                            <polygon points="0 0, 10 3.5, 0 7" />
                        </marker>
                        <marker id="arrowheadR" markerWidth="10" markerHeight="7" 
                                refX="10" refY="3.5" orient="auto" fill="red">
                            <polygon points="0 0, 10 3.5, 0 7" />
                        </marker>
                        </defs>
                    </svg>
                    <div id="attackPopup" class="card shadow-sm p-2"
                        style="position:absolute; z-index:999; width:120px; text-align:center; opacity:0.5; display:none;">
                        <div>允许攻击？<span id="attackCountdown"></span></div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-success me-1" id="acceptAttack">允许</button>
                            <button class="btn btn-sm btn-danger" id="rejectAttack">拒绝</button>
                        </div>
                    </div>
                    <div id="tagPopup" class="card shadow-sm p-2"
                        style="position:absolute; z-index:999; width:180px; text-align:center; display:none;">
                        <div class="d-flex justify-content-center flex-wrap">
                            {% for i in ('!', '?', '大', '小', '一', '二', '三', '旗', '司', '军', '师', '旅', '团', '营', '连', '排', '兵', '雷', '弹', 'X') %}
                            <div class="m-1 rounded-circle border" 
                                style="width:30px; height:30px; cursor: pointer;" onclick="tagChess('{{ i }}');">
                                <span style="line-height:30px; font-weight:bold;">{{ i }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div id="emojiPopup" class="card shadow-sm p-2"
                        style="position:absolute; z-index:999; width:360px; text-align:center; display:none;">
                        <div class="d-flex justify-content-center flex-wrap">
                            {% for i in range(1, 5) %}
                            <div class="m-1" 
                                style="width:60px; height:60px; cursor: pointer;" 
                                onclick="sendEmoji({{ i }});">
                                <img src="/img/emoji{{ i }}.png" alt="emoji" style="width:100%; height:100%;">
                            </div>
                            {% endfor %}
                            <div class="m-1 rounded-circle border" 
                                style="width:60px; height:60px; cursor: pointer;" onclick="$('#emojiPopup').hide();">
                                <span style="line-height:60px; font-weight:bold; font-size: 30px">X</span>
                            </div>
                        </div>
                    </div>
                    <div id="chatPopup" class="card shadow-sm p-2 chatWindow"
                        style="position:absolute; z-index:1000; width:400px; top: 300px; left: 300px;
                            text-align:left; opacity: 0.5; display:none;">
                    </div>
                    <!-- 行棋提示器 -->
                    <svg id="sectorSvg" width="200" height="200" style="position:absolute; left:400px; top:400px; z-index:5;">
                        <path id="sectorPath" fill="rgba(40,167,69,0.2)" stroke="#28a745" stroke-width="2"/>
                    </svg>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2 mx-4">
                    <a href="/formation?ret={{ request.path }}" class="d-grid text-decoration-none">
                        <button type="submit" class="btn btn-primary">
                            编辑阵型 <i class="fa-solid fa-edit"></i>
                        </button>
                    </a>
                    <span>选择阵型</span>
                    <select id="formationSelect" class="form-select" style="width: 200px;"></select>
                    <span>调整位置</span>
                    <button id="formationPosRight" class="btn btn-primary"><i class="fas fa-rotate-right"></i></button>
                    <button id="formationPosLeft" class="btn btn-primary"><i class="fas fa-rotate-left"></i></button>
                    <button id="setFormationBtn" class="btn btn-success" disabled>
                        <i class="fas fa-check me-2"></i>确认布阵
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let colors = {{ colors | tojson }};
let positions = {{ positions | tojson }};
let userId = "{{ user_id }}";
let roomId = {{ room_id }};
let roomType = {{ room.room_type }};
let userSeat = 0;
let isActive = {{ 'true' if room.active else 'false' }};

// 更新房间状态
function updateRoomStatus() {
    $.getJSON(`/api/room_status/${roomId}`, function(data) {
        roomType = data.room_type;
        isActive = data.status;

        // 更新房间状态
        $('#roomTypeSelect').val(data.room_type);
        $('#board-img').attr('src', `/img/${data.room_type}.jpg`);
        
        // 更新开始游戏按钮
        $('#startGameBtn').prop('disabled', !data.can_start);
        if (data.status) {
            $('#startGameBtn').hide();
            $('#EndGameBtn').show();
        } else {
            $('#startGameBtn').show();
            $('#EndGameBtn').hide();
        }
        
        // 创建所有座位的数组
        let allSeats = [];
        for (let i = 1; i <= data.room_type; i++) {
            allSeats.push(i);
        }
        
        // 更新玩家列表 - 按座位顺序显示
        let playersHtml = '';
        
        // 先创建已占用的座位
        let occupiedSeats = {};
        userSeat = 0; // 重置用户座位
        data.players.forEach(player => {
            occupiedSeats[player.seat] = player;
            
            // 记录用户座位
            if (player.user_id === userId) {
                userSeat = player.seat;
            }
        });
        
        // 按座位顺序显示
        allSeats.forEach(seat => {
            if (occupiedSeats[seat]) {
                const player = occupiedSeats[seat];
                playersHtml += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge me-2" style="background:${colors[seat]}">${seat}号位</span>
                            <span>${player.username}</span>
                            <span class="badge bg-${player.online ? 'success' : 'danger'} ms-2">
                                ${player.online ? '在线' : '离线'}
                            </span>
                        </div>
                        <div>
                            ${player.user_id !== userId ? `
                                <button class="btn btn-sm btn-outline-danger kick-btn" data-seat="${seat}">
                                    <i class="fas fa-user-times"></i>
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-outline-warning leave-btn" data-seat="${seat}">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            `}
                        </div>
                    </div>
                `;
            } else {
                // 空座位
                playersHtml += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge me-2" style="background:${colors[seat]}">${seat}号位</span>
                            <span class="text-muted">空座位</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary seat-btn" data-seat="${seat}">
                                <i class="fas fa-chair"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        });
        
        $('#playersList').html(playersHtml);
        
        // 更新用户座位信息
        if (userSeat > 0) {
            $('#userSeatInfo').html(`您坐在 <span class="badge" style="background:${colors[userSeat]}">${userSeat}号位</span> - 您可以点击离座按钮退出座位`);
        } else {
            $('#userSeatInfo').html('您当前是观战状态 - 点击空座位的椅子图标可以加入游戏');
        }
        
        // 绑定事件
        bindEvents();
    });
}

let chessMap = {};
let selectedId = null;
let selectedForTag = null;
function updateBoard(board, battle) {
  const container = $("#boardContainer");
  const arrowLayer = $("#arrowLayer");
  let tags = $.cookie(`tags_${roomId}`) || '{}';
  tags = JSON.parse(tags);

  // 更新棋子
  board.chesses.forEach(chess => {
    let el = chessMap[chess.id];
    if (!el) {
        // 新建棋子节点 (Bootstrap 风格圆形按钮)
        el = $(`<div class="btn btn-sm rounded-circle border fw-bold" 
                    style="width:40px; height:40px; line-height:28px;
                            color:white; font-size:18px; z-index:10;
                            position:absolute; text-align:center;"></div>`);
        el.attr("data-id", chess.id);
        el.attr("data-team", chess.team);
        container.append(el);
        chessMap[chess.id] = el;
        // 设置不同队伍颜色
        el.css("background-color", colors[chess.team]);
      
        // 点击棋子事件
        el.on("click", function(e) {
            e.stopPropagation(); // 阻止冒泡到棋盘
            const cid = parseInt($(this).attr("data-id"));
            const chessObj = board.chesses.find(c => c.id === cid);

            if (chessObj.team == userSeat) {
                if (selectedId === cid) {
                    // 再点同一颗 -> 取消选中
                    $(this).removeClass("border-3 border-dark");
                    selectedId = null;
                } else {
                    // 切换选中
                    if (selectedId !== null) {
                        chessMap[selectedId].removeClass("border-3 border-dark");
                    }
                    $(this).addClass("border-3 border-dark");
                    selectedId = cid;
                    $('#selectSound')[0].play();
                }
            }else{
                if (selectedId == null){
                    selectedForTag = cid;
                    $('#tagPopup').css({
                        left: ($(this).position().left + 45) + "px",
                        top:  ($(this).position().top - 10) + "px"
                    }).show();
                } else {
                    if (chessMap[selectedId].text() == '雷' || chessMap[selectedId].text() == '旗') {
                        alert('雷和旗不能攻击！');
                        return;
                    }
                    $.ajax({
                        url: '/api/attack_chess',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            room_id: roomId,
                            attacker: selectedId,
                            defender: cid
                        }),
                        success: function(response) {
                            if (response.status !== 'success') {
                                alert('攻击失败: ' + response.message);
                            }
                        }
                    });
                    chessMap[selectedId].removeClass("border-3 border-dark");
                    selectedId = null;
                }
            }
        });
    }
    if (chess.name == '')
        el.text(tags[chess.id] || ''); // 显示标记
    else
        el.text(chess.name); // 亮旗会变，因此放外面

    if (chess.alive) {
        el.show();

        // 平滑移动动画（300ms）
        el.stop(true).animate({
            left: chess.x + "px",
            top:  chess.y + "px"
        }, 300);
    } else {
        el.hide();
    }
  });

  // 更新箭头
  arrowLayer.find("line").remove();
  if (board.last_move) {
    drawArrow(board.last_move);
  }
  $('#attackPopup').hide();
  if (battle) {
    const attacker = battle.attacker;
    const defender = battle.defender;
    const atkChess = board.chesses.find(c => c.id === attacker);
    const defChess = board.chesses.find(c => c.id === defender);
    if (atkChess && defChess) {
        let line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", atkChess.x + 20); // 棋子中心
        line.setAttribute("y1", atkChess.y + 20);
        line.setAttribute("x2", defChess.x + 20);
        line.setAttribute("y2", defChess.y + 20);
        line.setAttribute("stroke", "red");
        line.setAttribute("stroke-width", "2");
        line.setAttribute("marker-end", "url(#arrowheadR)");
        arrowLayer.append(line);

        $('#attackPopup').css({
            left: (defChess.x - 40) + "px",
            top:  (defChess.y - 60) + "px"
        });
        if(battle.battle_time < 5)
            $('#attackCountdown').text(` ${5 - battle.battle_time}`);
        else
            $('#attackCountdown').text(``);
        if (defChess.team == userSeat || (userSeat !== 0 && battle.battle_time >= 5))
            $('#attackPopup').show();
    }
  }
}
function drawArrow(move) {
    const [old_x, old_y, new_x, new_y] = move;
    let line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", old_x + 20); // 棋子中心
    line.setAttribute("y1", old_y + 20);
    line.setAttribute("x2", new_x + 20);
    line.setAttribute("y2", new_y + 20);
    line.setAttribute("stroke", "black");
    line.setAttribute("stroke-width", "2");
    line.setAttribute("marker-end", "url(#arrowheadB)");
    arrowLayer.append(line);
}

let last_battle_pair = (null, null);
let last_record_id = null;
function playSound(battle, record_id, battle_result) {
    battle_pair = [battle ? battle.attacker : null, battle ? battle.defender : null];
    if (battle && (battle_pair[0] != last_battle_pair[0] || battle_pair[1] != last_battle_pair[1])) {
        $('#attackSound')[0].play();
    }
    last_battle_pair = battle_pair;

    if (record_id != last_record_id) {
        if (battle_result) {
            $('#' + battle_result + 'Sound')[0].play();
        } else {
            $('#moveSound')[0].play();
        }
        last_record_id = record_id;
        drawSector(1);
    }
}

// 获取聊天消息
let last_msg_timestamp = '';
function updateChatMessages() {
    $.getJSON(`/api/chat/messages/${roomId}`, function(data) {
        if (data.status === 'success') {
            let messagesHtml = '';
            
            // 生成消息HTML
            data.messages.forEach(msg => {
                if (msg.is_system) {
                    // 系统消息
                    messagesHtml += `
                        <div class="mb-2 text-center">
                            <small class="text-muted">[${msg.timestamp}] ${msg.content}</small>
                        </div>
                    `;
                } else {
                    // 用户消息
                    messagesHtml += `
                        <div class="mb-2">
                            <strong>${msg.sender}:</strong> ${msg.content}
                            <small class="text-muted float-end">${msg.timestamp}</small>
                        </div>
                    `;
                }
            });
            
            $('#chatWindow').html(messagesHtml);
            
            // 滚动到底部
            new_last_msg_timestamp = data.messages.length > 0 ? data.messages[data.messages.length - 1].timestamp : '';
            if(new_last_msg_timestamp !== last_msg_timestamp){
                last_msg_timestamp = new_last_msg_timestamp;
                $('#chatWindow').scrollTop($('#chatWindow')[0].scrollHeight);
            }

            // 在弹窗显示最近5秒的消息
            const messagesForPopup = data.messages.filter(msg => { return msg.is_recent; });
            const messagesContainer = $('#chatPopup');

            // 显示最近5秒的消息
            messagesContainer.empty();
            messagesForPopup.forEach(msg => {
                messagesContainer.append(`
                    <div class="mb-2">
                        <strong>${msg.sender}:</strong> ${msg.content}
                        <small class="text-muted float-end">${msg.timestamp}</small>
                    </div>
                `);
            });
            if(messagesForPopup.length > 0)
                messagesContainer.show();
            else
                messagesContainer.hide();
            
            // 显示emoji表情
            const container = $("#boardContainer");
            container.find("img.emoji").remove();
            data.emojis.forEach(emoji => {
                const img = $('<img>').addClass('emoji').attr('src', '/img/emoji' + emoji.emoji + '.png').css({
                    left: emoji.x,
                    top: emoji.y,
                    position: 'absolute',
                    width: '60px',
                    height: '60px'
                });
                img.css({
                    border: '2px solid ' + colors[emoji.team_id],
                    borderRadius: '12px',
                    boxSizing: 'border-box',
                });
                container.append(img);
            });
        }
    });
}

// 发送聊天消息
function sendChatMessage() {
    const content = $('#chatInput').val().trim();
    if (content) {
        $.ajax({
            url: '/api/chat/send',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                room_id: roomId,
                content: content
            }),
            success: function(response) {
                if (response.status === 'success') {
                    $('#chatInput').val(''); // 清空输入框
                    updateChatMessages(); // 更新消息显示
                } else {
                    alert('发送消息失败: ' + response.message);
                }
            }
        });
    }
}

function sendEmoji(id)
{
    pos = $('#emojiPopup').position();
    const x = pos.left + 180;
    const y = pos.top + 42;
    // 直接显示刚发送的emoji表情
    const container = $("#boardContainer");
    const img = $('<img>').addClass('emoji').attr('src', '/img/emoji' + id + '.png').css({
        left: x - 30,
        top: y - 30,
        position: 'absolute',
        width: '60px',
        height: '60px'
    });
    img.css({
        border: '2px solid ' + colors[userSeat],
        borderRadius: '12px',
        boxSizing: 'border-box',
    });
    container.append(img);
    $.ajax({
        url: '/api/emoji/send',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            'room_id': roomId,
            'emoji_id': id,
            'x': x - 30,
            'y': y - 30
        }),
        success: function(response) {
            if (response.status !== 'success') {
                alert('发送Emoji失败: ' + response.message);
            }
        }
    });
    $('#emojiPopup').hide();
}

function tagChess(tag) {
    if (tag === 'X') tag = '';
    if(selectedForTag !== null){
        tags = $.cookie(`tags_${roomId}`) || '{}';
        tags = JSON.parse(tags);
        tags[selectedForTag] = tag;
        $.cookie(`tags_${roomId}`, JSON.stringify(tags), { path: '/' });
        selectedForTag = null;
        $('#tagPopup').hide();
    }
}

// 绑定事件处理函数
function bindEvents() {
    // 占座按钮
    $('.seat-btn').click(function() {
        const seat = $(this).data('seat');
        $.post(`/api/take_seat/${roomId}/${seat}`, function(response) {
            if (response.status === 'success') {
                updateRoomStatus();
            } else {
                alert(response.message);
            }
        });
    });
    
    // 离座按钮
    $('.leave-btn').click(function() {
        const seat = $(this).data('seat');
        if(!isActive || confirm('当前游戏正在进行中，离座将会退出游戏。确定要离座吗？')){
            $.post(`/api/leave_seat/${roomId}/${seat}`, function(response) {
                if (response.status === 'success') {
                    updateRoomStatus();
                } else {
                    alert(response.message);
                }
            });
        }
    });
    
    // 踢人按钮
    $('.kick-btn').click(function() {
        const seat = $(this).data('seat');
        if (confirm('确定要踢出该玩家吗？')) {
            $.post(`/api/kick_player/${roomId}/${seat}`, function(response) {
                if (response.status === 'success') {
                    updateRoomStatus();
                } else {
                    alert(response.message);
                }
            });
        }
    });
}

// 修改房间类型
$('#roomTypeSelect').change(function(e) {
    const newType = $(this).val();
    if (confirm(`确定要修改房间类型为${newType}人吗？超出位置的玩家将被自动踢出。`)) {
        $.ajax({
            url: `/api/change_room_type/${roomId}`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ room_type: parseInt(newType) }),
            success: function(response) {
                if (response.status === 'success') {
                    updateRoomStatus();
                } else {
                    alert(response.message);
                }
            }
        });
    } else {
        e.preventDefault();
    }
});

// 开始游戏
$('#startGameBtn').click(function() {
    $.post(`/api/start_game/${roomId}`, function(response) {
        if (response.status === 'success') {
            updateRoomStatus();
        } else {
            alert(response.message);
        }
    });
});

// 结束游戏
$('#EndGameBtn').click(function() {
    if (confirm('确定要结束当前游戏吗？')) {
        $.post(`/api/stop_game/${roomId}`, function(response) {
            if (response.status === 'success') {
                updateRoomStatus();
            } else {
                alert(response.message);
            }
        });
    }
});

// 防止弹窗穿透
$('#tagPopup, #emojiPopup, #attackPopup').click(function(e) {
    e.stopPropagation();
});
// 棋盘点击：移动己方选中棋子
$("#boardContainer").on("click", function(e) {
    if($('#emojiPopup').is(':visible')){
        $('#emojiPopup').hide();
        return;
    }
    if ($('#tagPopup').is(':visible')) {
        $('#tagPopup').hide();
        selectedForTag = null;
        return;
    }

    if (selectedId === null) {
        // 没有选中棋子，显示表情选择
        if (userSeat > 0) {
            $('#emojiPopup').css({
                left: (e.pageX - $(this).offset().left - 180) + "px",
                top:  (e.pageY - $(this).offset().top - 42) + "px"
            }).show();
        }
        return;
    }

    const offset = $(this).offset();
    let x = e.pageX - offset.left - 20;
    let y = e.pageY - offset.top - 20;

    // 找到最近的9个可用点，按距离排序
    const pool = positions[roomType];
    let nearest = pool.map(pos => {
        return {
            pos: pos,
            dist: Math.hypot(pos[0] - x, pos[1] - y)
        };
    });
    nearest.sort((a, b) => a.dist - b.dist);
    nearest = nearest.slice(0, 9);
    // 从最近的9个点中选择一个未被占用的点
    for (let item of nearest) 
        if (item.dist < 40) { // 至少距离40像素以内
            const occupied = Object.values(chessMap).some(el => {
                const elX = parseInt(el.css("left"));
                const elY = parseInt(el.css("top"));
                return el.is(":visible") && Math.hypot(elX - item.pos[0], elY - item.pos[1]) < 20; // 20像素内视为占用
            });
            if (!occupied) {
                x = item.pos[0];
                y = item.pos[1];
                break;
            }
        }

    // 先弄出箭头
    const [old_x, old_y] = [chessMap[selectedId].position().left, chessMap[selectedId].position().top];
    drawArrow([old_x, old_y, x, y]);
    // 这里你可能要发请求给后端 API 告诉服务器移动动作
    $.ajax({
        url: '/api/move_chess',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            room_id: roomId,
            chess_id: selectedId,
            new_x: x,
            new_y: y
        }),
        success: function(response) {
            if (response.status !== 'success') {
                alert('移动失败: ' + response.message);
            } else {
                drawArrow([old_x, old_y, x, y]); // 确认移动后再画一次箭头
            }
        }
    });

    // 移动后取消选中
    chessMap[selectedId].removeClass("border-3 border-dark");
    selectedId = null;
});

function respondToAttack(accept) {
    $.ajax({
        url: '/api/respond_attack',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            room_id: roomId,
            accept: accept
        }),
        success: function(response) {
            if (response.status !== 'success') {
                alert('操作失败: ' + response.message);
            }
        }
    });
}

$('#acceptAttack').click(function(e) {
    e.stopPropagation();
    respondToAttack(true);
});

$('#rejectAttack').click(function(e) {
    e.stopPropagation();
    respondToAttack(false);
});

// 发送消息按钮点击事件
$('#sendMessageBtn').click(sendChatMessage);

// 输入框回车键发送消息
$('#chatInput').keypress(function(e) {
    if (e.which === 13) { // 回车键
        sendChatMessage();
        return false; // 阻止默认行为
    }
});

$('#clearTagBtn').click(function() {
    $.cookie(`tags_${roomId}`, '', { path: '/' });
});

// 定时更新房间状态和用户最后登录时间
setInterval(function() {
    updateRoomStatus();
    $.post('/api/update_last_login');
}, 500);

setInterval(() => {
    if(isActive){
        $.getJSON(`/api/board/${roomId}`, function(res) {
            if (res.status === "success") {
                updateBoard(res.board, res.battle);
                playSound(res.battle, res.record_id, res.board.last_battle_result);
            }
        });
    }else{
        // 清除棋盘
        Object.values(chessMap).forEach(el => el.remove());
        chessMap = {};
        selectedId = null;
        $("#arrowLayer").find("line").remove();
    }
}, 500);

// 定时更新聊天消息
setInterval(updateChatMessages, 1000);

// 行棋提示器
let sectorStep = 0;
function drawSector(delta) {
    sectorStep = (sectorStep + delta) % roomType;
    const n = roomType;
    const angle = 360 / n;
    const startAngle = angle * -sectorStep - angle / 2 - 90;
    const endAngle = angle * -sectorStep + angle / 2 - 90;
    const r = 100, cx = 100, cy = 100;
    const rad = a => a * Math.PI / 180;
    const x1 = cx + r * Math.cos(rad(startAngle));
    const y1 = cy + r * Math.sin(rad(startAngle));
    const x2 = cx + r * Math.cos(rad(endAngle));
    const y2 = cy + r * Math.sin(rad(endAngle));
    const largeArc = angle > 180 ? 1 : 0;
    const d = [
        `M ${cx} ${cy}`,
        `L ${x1} ${y1}`,
        `A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2}`,
        'Z'
    ].join(' ');
    $('#sectorPath').attr('d', d);
}
$('#sectorLeftBtn').click(function() {
    drawSector(-1);
});
$('#sectorRightBtn').click(function() {
    drawSector(1);
});

let formationPos = 0;
let previewChess = [];
function renderFormationPreview()
{
    Object.values(previewChess).forEach(el => el.remove());
    previewChess = [];

    const select = $('#formationSelect');
    const idx = parseInt(select.val());
    if (isNaN(idx) || idx < 0) {
        $('#setFormationBtn').prop('disabled', true);
        return;
    }
    let formations = $.cookie('formations') || '[]';
    formations = JSON.parse(formations);
    const formation = formations[idx].matrix;
    $('#setFormationBtn').prop('disabled', false);

    // 计算偏移
    const pool = positions[roomType];
    formationPos = formationPos % roomType;
    const basePos = formationPos * 30;

    // 显示预览
    formation.forEach((text, i) => {
        if (text === '') return;
        let el = $(`<div class="btn btn-sm rounded-circle border fw-bold" 
                    style="width:40px; height:40px; line-height:28px;
                            color:white; font-size:18px; z-index:20;
                            position:absolute; text-align:center;"></div>`);
        el.css("background-color", colors[0]);
        el.text(text);
        el.css({
            left: (pool[basePos + i][0]) + "px",
            top:  (pool[basePos + i][1]) + "px"
        });
        $('#boardContainer').append(el);
        previewChess.push(el);
    });
}
let lastFormationsStr = '';
$('#formationSelect').on('focus', function() {
    let formationsStr = $.cookie('formations') || '[]';
    if (formationsStr === lastFormationsStr) return; // 没有变化不刷新
    lastFormationsStr = formationsStr;
    const select = $(this);
    select.empty();
    select.append($('<option>').val(-1).text('请选择'));
    let formations = JSON.parse(formationsStr);
    formations.forEach((f, i) => {
        select.append($('<option>').val(i).text(f.name));
    });
    renderFormationPreview();
});
$('#formationSelect').change(function() {
    renderFormationPreview();
});
$('#formationPosLeft').click(function() {
    formationPos = (formationPos - 1 + roomType) % roomType;
    renderFormationPreview();
});
$('#formationPosRight').click(function() {
    formationPos = (formationPos + 1) % roomType;
    renderFormationPreview();
});
$('#setFormationBtn').click(function() {
    if (userSeat === 0) {
        alert('观战状态无法布阵，请先占座！');
        return;
    }
    if (!isActive) {
        alert('当前游戏未开始，无法布阵！');
        return;
    }

    const select = $('#formationSelect');
    const idx = parseInt(select.val());
    let formations = $.cookie('formations') || '[]';
    formations = JSON.parse(formations);
    const formation = formations[idx].matrix;

    previewChess.forEach(el => el.remove());
    previewChess = [];
    
    $.ajax({
        url: '/api/set_formation',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            room_id: roomId,
            formation: formation,
            positions: positions[roomType].slice(formationPos * 30, formationPos * 30 + 30)
        }),
        success: function(response) {
            if (response.status === 'success') {
                alert('布阵成功！');
            } else {
                alert('布阵失败: ' + response.message);
            }
        }
    });
});

// 初始加载
$(document).ready(function() {
    updateRoomStatus();
    updateChatMessages();
});
</script>
{% endblock %}