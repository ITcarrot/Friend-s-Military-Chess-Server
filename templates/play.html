{% extends "base.html" %}

{% block title %}房间 {{ room_id }} - 军旗棋盘{% endblock %}

{% block content %}
<audio id="selectSound" src="/static/audio/select.mp3" preload="auto"></audio>
<audio id="moveSound" src="/static/audio/move.mp3" preload="auto"></audio>
<audio id="attackSound" src="/static/audio/attack.mp3" preload="auto"></audio>
<audio id="40lostSound" src="/static/audio/40lost.mp3" preload="auto"></audio>
<audio id="winSound" src="/static/audio/win.mp3" preload="auto"></audio>
<audio id="loseSound" src="/static/audio/lose.mp3" preload="auto"></audio>
<audio id="drawSound" src="/static/audio/draw.mp3" preload="auto"></audio>

<div class="d-flex justify-content-between mb-4">
    <a href="/" class="btn btn-secondary" onclick="$('.leave-btn').click();">
        <i class="fas fa-arrow-left me-2"></i>返回首页
    </a>
</div>

<div class="row">
    <!-- 左侧：信息和管理区域 -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">房间控制</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">房间类型</label>
                    <select class="form-select" id="roomTypeSelect">
                        <option value="2" {% if room.room_type == 2 %}selected{% endif %}>2人游戏</option>
                        <option value="4" {% if room.room_type == 4 %}selected{% endif %}>4人游戏</option>
                        <option value="6" {% if room.room_type == 6 %}selected{% endif %}>6人游戏</option>
                        <option value="8" {% if room.room_type == 8 %}selected{% endif %}>8人游戏</option>
                    </select>
                </div>
                
                <div class="d-grid">
                    <button id="startGameBtn" class="btn btn-success mb-2" {% if not room.can_start_game() %}disabled{% endif %} {% if room.active %}style="display:none"{% endif %}>
                        <i class="fas fa-play me-2"></i>开始游戏
                    </button>
                    <button id="EndGameBtn" class="btn btn-danger" {% if not room.active %}style="display:none"{% endif %}>
                        <i class="fas fa-stop me-2"></i>结束游戏
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">玩家座位</h4>
            </div>
            <div class="card-body p-0">
                <div id="playersList" class="list-group list-group-flush">
                    <!-- 玩家列表将通过JavaScript动态更新 -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="userSeatInfo" class="alert alert-info mt-3">
            <!-- 用户座位信息将通过JavaScript动态更新 -->
        </div>
        
        <!-- 聊天窗口 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-comments me-2"></i>聊天窗口</h5>
            </div>
            <div class="card-body p-0">
                <div class="chatWindow" id="chatWindow">
                    <!-- 聊天消息将通过JavaScript动态更新 -->
                </div>
            </div>
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" class="form-control" id="chatInput" placeholder="输入消息..." autocomplete="off">
                    <button class="btn btn-primary" id="sendMessageBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 棋盘区域 -->
    <div class="col-md-8">
        <div class="card" style="width: 1032px;">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-chess-rook me-2"></i>军旗棋盘 - 房间 {{ room_id }}</h3>
                <button class="btn btn-md btn-success" id="tagFirstRow" style="position: absolute; right:120px; top:20px;">
                    标记首行
                </button>
                <button class="btn btn-md btn-danger" id="clearTagBtn" style="position: absolute; right:20px; top:20px;">
                    清空标记</button>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">提示：点击棋盘空白处可发送表情</span>
                    <span class="text-muted">
                        行棋提示器校准：
                        <button id="sectorLeftBtn" class="btn btn-sm btn-primary me-2"><i class="fas fa-rotate-right"></i></button>
                        <button id="sectorRightBtn" class="btn btn-sm btn-primary"><i class="fas fa-rotate-left"></i></button>
                    </span>
                </div>
                <div class="text-center mb-4" style="height: 1000px; position: relative;" id="boardContainer">
                    <img id="board-img" src="" alt="军旗棋盘" class="img-fluid" style="max-height: 100%; max-width: 100%;">
                    <svg id="arrowLayer" width="100%" height="100%" 
                        style="position:absolute; top:0; left:0; pointer-events:none; z-index:20;">
                        <defs>
                        <marker id="arrowheadB" markerWidth="10" markerHeight="7" 
                                refX="10" refY="3.5" orient="auto" fill="black">
                            <polygon points="0 0, 10 3.5, 0 7" />
                        </marker>
                        <marker id="arrowheadR" markerWidth="10" markerHeight="7" 
                                refX="10" refY="3.5" orient="auto" fill="red">
                            <polygon points="0 0, 10 3.5, 0 7" />
                        </marker>
                        </defs>
                    </svg>
                    <div id="attackPopup" class="card shadow-sm p-2"
                        style="position:absolute; z-index:999; width:120px; text-align:center; opacity:0.5; display:none;">
                        <div>允许攻击？<span id="attackCountdown"></span></div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-success me-1" id="acceptAttack">允许</button>
                            <button class="btn btn-sm btn-danger" id="rejectAttack">拒绝</button>
                        </div>
                    </div>
                    <div id="tagPopup" class="card shadow-sm p-2"
                        style="position:absolute; z-index:999; width:180px; text-align:center; display:none;">
                        <div class="d-flex justify-content-center flex-wrap">
                            {% for i in ('!', '?', '大', '小', '一', '二', '三', '旗', '司', '军', '师', '旅', '团', '营', '连', '排', '兵', '雷', '弹', 'X') %}
                            <div class="m-1 rounded-circle border selectTag" onclick="tagChess('{{ i }}');">
                                <span>{{ i }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div id="emojiPopup" class="card shadow-sm p-2"
                        style="position:absolute; z-index:999; width:360px; text-align:center; display:none;">
                        <div class="d-flex justify-content-center flex-wrap">
                            {% for i in range(1, 5) %}
                            <div class="m-1 selectEmoji" onclick="sendEmoji({{ i }});">
                                <img src="/static/img/emoji{{ i }}.png" alt="emoji">
                            </div>
                            {% endfor %}
                            <div class="m-1 rounded-circle border selectEmoji" onclick="$('#emojiPopup').hide();">
                                <span style="line-height:60px; font-weight:bold; font-size: 30px">X</span>
                            </div>
                        </div>
                    </div>
                    <div id="chatPopup" class="card shadow-sm p-2 chatWindow"
                        style="position:absolute; z-index:1000; width:400px; top: 300px; left: 300px;
                            text-align:left; opacity: 0.5; display:none;">
                    </div>
                    <!-- 行棋提示器 -->
                    <svg id="sectorSvg" width="200" height="200" style="position:absolute; left:400px; top:400px; z-index:5;">
                        <path id="sectorPath" fill="rgba(40,167,69,0.2)" stroke="#28a745" stroke-width="2"/>
                    </svg>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2 mx-4">
                    <a href="/formation?ret={{ request.path }}" class="d-grid text-decoration-none">
                        <button type="submit" class="btn btn-primary">
                            编辑阵型 <i class="fa-solid fa-edit"></i>
                        </button>
                    </a>
                    <span>选择阵型</span>
                    <select id="formationSelect" class="form-select" style="width: 200px;"></select>
                    <span>调整位置</span>
                    <button id="formationPosRight" class="btn btn-primary"><i class="fas fa-rotate-right"></i></button>
                    <button id="formationPosLeft" class="btn btn-primary"><i class="fas fa-rotate-left"></i></button>
                    <button id="setFormationBtn" class="btn btn-success" disabled>
                        <i class="fas fa-check me-2"></i>确认布阵
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="loadingOverlay">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">通信中...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let colors = {{ colors | tojson }};
let positions = {};
let userId = "{{ user_id }}";
let roomId = {{ room_id }};
let roomType = {{ room.room_type }};
let userSeat = 0;
let isActive = {{ 'true' if room.active else 'false' }};
</script>
<script src="/static/js/play.js"></script>
{% endblock %}