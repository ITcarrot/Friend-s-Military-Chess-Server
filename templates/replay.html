{% extends "base.html" %}

{% block title %}观看复盘{% endblock %}

{% block content %}
<audio id="moveSound" src="/audio/move.mp3" preload="auto"></audio>
<audio id="40lostSound" src="/audio/40lost.mp3" preload="auto"></audio>
<audio id="winSound" src="/audio/win.mp3" preload="auto"></audio>
<audio id="loseSound" src="/audio/lose.mp3" preload="auto"></audio>
<audio id="drawSound" src="/audio/draw.mp3" preload="auto"></audio>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">对局复盘</h4>
                <a href="/replay_list" class="btn btn-secondary">返回列表</a>
            </div>
            <div class="card-body">
                <div id="playersList" class="list-group list-group-flush">
                    {% for idx, player in players %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="badge me-2" style="background:{{ colors[idx + 1] }}">{{ idx + 1 }}号位</span>
                            <span>{{ player }}</span>
                        </div>
                    {% endfor %}
                </div>
                <div>
                    <div class="d-flex justify-content-center">
                        <div class="btn-group mb-2" role="group" aria-label="Replay controls">
                            <button type="button" class="btn btn-primary mx-2" onclick="prevStep()">
                                <i class="fa-solid fa-backward"></i>
                            </button>
                            <button type="button" class="btn btn-primary mx-2" onclick="playPause()">
                                <i class="fa-solid fa-play" id="playPauseBtn"></i>
                            </button>
                            <button type="button" class="btn btn-primary mx-2" onclick="nextStep()">
                                <i class="fa-solid fa-forward"></i>
                            </button>
                        </div>
                    </div>
                    <input type="range" class="form-range" min="1" max="{{ records.__len__() }}" value="1" id="replayRange" oninput="updateReplay(this.value)">
                    <div class="d-flex justify-content-between">
                        <span>1</span>
                        <span id="currentStep">1</span>
                        <span>{{ records.__len__() }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 右侧：棋盘 -->
    <div class="col-md-8">
        <div class="card" style="width: 1032px;">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-chess-rook me-2"></i>对局棋盘</h3>
            </div>
            <div class="card-body">
                <div class="text-center my-4" style="height: 1000px; position: relative;" id="boardContainer">
                    <img id="board-img" src="/img/{{ room_type }}.jpg" alt="军旗棋盘" class="img-fluid" style="max-height: 100%; max-width: 100%;">
                    <svg id="arrowLayer" width="100%" height="100%" 
                        style="position:absolute; top:0; left:0; pointer-events:none; z-index:20;">
                        <defs>
                        <marker id="arrowheadB" markerWidth="10" markerHeight="7" 
                                refX="10" refY="3.5" orient="auto" fill="black">
                            <polygon points="0 0, 10 3.5, 0 7" />
                        </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let colors = {{ colors | tojson }};
let autoPlayInterval = null;
let records = {{ records|tojson }};
let chessMap = {};

function updateReplay(step) {
    const container = $("#boardContainer");
    const arrowLayer = $("#arrowLayer");
    let board = JSON.parse(records[step - 1]);
    
  // 更新棋子
    board.chesses.forEach(chess => {
        let el = chessMap[chess.id];
        if (!el) {
            // 新建棋子节点 (Bootstrap 风格圆形按钮)
            el = $(`<div class="btn btn-sm rounded-circle border fw-bold" 
                        style="width:40px; height:40px; line-height:28px;
                                color:white; font-size:18px; z-index:10;
                                position:absolute; text-align:center;"></div>`);
            container.append(el);
            chessMap[chess.id] = el;
            el.text(chess.name); 
            // 设置不同队伍颜色
            el.css("background-color", colors[chess.team]);
        }
        if (chess.alive) {
            el.show();

            // 平滑移动动画（300ms）
            el.stop(true).animate({
                left: chess.x + "px",
                top:  chess.y + "px"
            }, 300);
        } else {
            el.hide();
        }
    });
    // 更新箭头
    arrowLayer.find("line").remove();
    if (board.last_move) {
        const [old_x, old_y, new_x, new_y] = board.last_move;
        let line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", old_x + 20); // 棋子中心
        line.setAttribute("y1", old_y + 20);
        line.setAttribute("x2", new_x + 20);
        line.setAttribute("y2", new_y + 20);
        line.setAttribute("stroke", "black");
        line.setAttribute("stroke-width", "2");
        line.setAttribute("marker-end", "url(#arrowheadB)");
        arrowLayer.append(line);
    }

    if (board.last_battle_result) {
        let soundStr = Array.isArray(board.last_battle_result) ? board.last_battle_result[0] : board.last_battle_result;
        $('#' + soundStr + 'Sound')[0].play();
    } else {
        $('#moveSound')[0].play();
    }

    $('#currentStep').text(step);
}
updateReplay(1); // 初始化显示第一步

function startAutoPlay() {
    $('#playPauseBtn').removeClass('fa-play').addClass('fa-pause');
    autoPlayInterval = setInterval(() => {
        let rangeInput = $('#replayRange')[0];
        let currentValue = parseInt(rangeInput.value);
        if (currentValue < parseInt(rangeInput.max)) {
            rangeInput.value = currentValue + 1;
            updateReplay(rangeInput.value);
        } else {
            stopAutoPlay();
        }
    }, 1000);
}

function stopAutoPlay() {
    $('#playPauseBtn').removeClass('fa-pause').addClass('fa-play');
    clearInterval(autoPlayInterval);
}

function playPause() {
    if ($('#playPauseBtn').hasClass('fa-play')) {
        if ($('#replayRange').val() == $('#replayRange').attr('max')) {
            $('#replayRange').val(1);
            updateReplay(1);
        }
        startAutoPlay();
    } else {
        stopAutoPlay();
    }
}

function prevStep() {
    stopAutoPlay();
    let rangeInput = $('#replayRange')[0];
    let currentValue = parseInt(rangeInput.value);
    if (currentValue > 1) {
        rangeInput.value = currentValue - 1;
        updateReplay(rangeInput.value);
    }
}

function nextStep() {
    stopAutoPlay();
    let rangeInput = $('#replayRange')[0];
    let currentValue = parseInt(rangeInput.value);
    if (currentValue < parseInt(rangeInput.max)) {
        rangeInput.value = currentValue + 1;
        updateReplay(rangeInput.value);
    }
}
</script>

{% endblock %}